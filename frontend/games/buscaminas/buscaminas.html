<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Buscaminas</title>
</head>
<body>
    <div class="container">
        <h1>Buscaminas</h1>
        
        <!-- Botones ocultos pero presentes para mantener estructura si se quiere reactivar -->
        <div class="niveles">
            <button class="nivel-btn" data-nivel="facil">F√°cil<br><small>8x8 / 10</small></button>
            <button class="nivel-btn" data-nivel="intermedio">Intermedio<br><small>16x16 / 40</small></button>
            <button class="nivel-btn" data-nivel="experto">Experto<br><small>16x30 / 99</small></button>
        </div>
        
        <div class="info">
            <div class="contador">
                <span>üí£ <span id="minas-restantes">10</span></span>
            </div>
            <div class="contador" id="dificultad-display">Dificultad: F√°cil</div>
            <div class="contador" id="emoji-cara">üôÇ</div>
            <div class="contador">
                <span>‚è±Ô∏è <span id="tiempo">60</span></span>
            </div>
        </div>

        <div id="mensaje"></div>
        <div id="tablero" class="tablero"></div>
    </div>

    <script>
        const NIVELES = {
            facil: { rows: 8, cols: 8, minas: 10, nombre: "F√°cil", tiempo: 60 },
            intermedio: { rows: 16, cols: 16, minas: 40, nombre: "Media", tiempo: 150 },
            experto: { rows: 16, cols: 30, minas: 99, nombre: "Dif√≠cil", tiempo: 180 }
        };

        let NIVEL_ACTUAL;
        let currentRows, currentCols, currentMinas, tiempoLimite;
        let tablero = document.getElementById('tablero');
        let mensaje = document.getElementById('mensaje');
        let minasRestantesDisplay = document.getElementById('minas-restantes');
        let tiempoDisplay = document.getElementById('tiempo');
        let emojiCara = document.getElementById('emoji-cara');
        let dificultadDisplay = document.getElementById('dificultad-display');

        let casillas = [];
        let minasMarcadas = 0;
        let casillasReveladas = 0;
        let juegoTerminado = false;
        let tiempoInicio = null;
        let tiempoRestante = null;
        let temporizador = null;

        function elegirDificultadAleatoria() {
            const niveles = Object.keys(NIVELES);
            const aleatorio = niveles[Math.floor(Math.random() * niveles.length)];
            NIVEL_ACTUAL = aleatorio;
            const config = NIVELES[NIVEL_ACTUAL];
            dificultadDisplay.textContent = `Dificultad: ${config.nombre}`;
            return config;
        }

        function iniciarJuego() {
            juegoTerminado = false;
            casillasReveladas = 0;
            minasMarcadas = 0;
            mensaje.textContent = '';
            emojiCara.textContent = 'üôÇ';
            clearInterval(temporizador);
            tiempoInicio = null;

            const config = elegirDificultadAleatoria();
            currentRows = config.rows;
            currentCols = config.cols;
            currentMinas = config.minas;
            tiempoLIMITE = config.tiempo;
            tiempoRestante = tiempoLIMITE;
            tiempoDisplay.textContent = tiempoRestante;
            minasRestantesDisplay.textContent = currentMinas;

            const maxDim = Math.max(currentRows, currentCols);
            const cellSize = Math.max(28, Math.min(50, Math.floor((window.innerWidth - 100) / maxDim)));
            tablero.style.setProperty('--cell-size', `${cellSize}px`);
            tablero.style.setProperty('--cols', currentCols);
            tablero.style.setProperty('--rows', currentRows);

            inicializaTablero();
        }

        function inicializaTablero() {
            tablero.innerHTML = '';
            casillas = [];
            for (let i = 0; i < currentRows; i++) {
                casillas[i] = [];
                for (let j = 0; j < currentCols; j++) {
                    let casilla = document.createElement('div');
                    casilla.classList.add('casilla');
                    casilla.dataset.row = i;
                    casilla.dataset.col = j;
                    casilla.dataset.state = 'hidden';
                    casilla.addEventListener('click', manejarClickIzquierdo);
                    casilla.addEventListener('contextmenu', manejarClickDerecho);
                    tablero.appendChild(casilla);
                    casillas[i][j] = casilla;
                }
            }
        }

        function colocarMinasExcluyendo(excludeRow, excludeCol) {
            let colocadas = 0;
            while (colocadas < currentMinas) {
                let row = Math.floor(Math.random() * currentRows);
                let col = Math.floor(Math.random() * currentCols);
                if ((row !== excludeRow || col !== excludeCol) && casillas[row][col].dataset.mine !== 'true') {
                    casillas[row][col].dataset.mine = 'true';
                    colocadas++;
                }
            }
        }

        function iniciarTemporizador() {
            temporizador = setInterval(() => {
                tiempoRestante--;
                tiempoDisplay.textContent = tiempoRestante;
                if (tiempoRestante <= 0) {
                    clearInterval(temporizador);
                    revelarTodasMinas();
                    mostrarMensaje('¬°Tiempo agotado! ‚è∞ Has perdido', true);
                    emojiCara.textContent = 'üòµ';
                    juegoTerminado = true;
                }
            }, 1000);
        }

        function manejarClickIzquierdo(e) {
            e.preventDefault();
            if (juegoTerminado) return;

            let casilla = e.target;
            let row = parseInt(casilla.dataset.row);
            let col = parseInt(casilla.dataset.col);

            if (casilla.dataset.state !== 'hidden') return;

            if (!tiempoInicio) {
                tiempoInicio = Date.now();
                colocarMinasExcluyendo(row, col);
                iniciarTemporizador();
            }

            if (casilla.dataset.mine === 'true') {
                revelarTodasMinas();
                casilla.classList.add('mina-explotada');
                clearInterval(temporizador);
                mostrarMensaje('¬°Boom! Has perdido üí•', true);
                emojiCara.textContent = 'üíÄ';
                juegoTerminado = true;
            } else {
                revelarCasilla(row, col);
                if (casillasReveladas === currentRows * currentCols - currentMinas) {
                    clearInterval(temporizador);
                    revelarTodasMinas();
                    mostrarMensaje('¬°Ganaste! üéâ', false);
                    emojiCara.textContent = 'üòé';
                    juegoTerminado = true;
                }
            }
        }

        function manejarClickDerecho(e) {
            e.preventDefault();
            if (juegoTerminado) return;

            let casilla = e.target;
            if (casilla.dataset.state === 'revealed') return;

            if (casilla.dataset.state === 'hidden') {
                casilla.textContent = 'üö©';
                casilla.dataset.state = 'flag';
                minasMarcadas++;
            } else if (casilla.dataset.state === 'flag') {
                casilla.textContent = '';
                casilla.dataset.state = 'hidden';
                minasMarcadas--;
            }
            minasRestantesDisplay.textContent = currentMinas - minasMarcadas;
        }

        function revelarCasilla(row, col) {
            let casilla = casillas[row][col];
            if (casilla.dataset.state !== 'hidden') return;

            let count = contarMinasCercanas(row, col);
            casilla.textContent = count || '';
            if (count > 0) casilla.classList.add('num-' + count);
            casilla.dataset.state = 'revealed';
            casilla.classList.add('revealed');
            casillasReveladas++;

            if (count === 0) {
                for (let i = Math.max(0, row - 1); i <= Math.min(row + 1, currentRows - 1); i++) {
                    for (let j = Math.max(0, col - 1); j <= Math.min(col + 1, currentCols - 1); j++) {
                        if (i !== row || j !== col) {
                            revelarCasilla(i, j);
                        }
                    }
                }
            }
        }

        function contarMinasCercanas(row, col) {
            let count = 0;
            for (let i = Math.max(0, row - 1); i <= Math.min(row + 1, currentRows - 1); i++) {
                for (let j = Math.max(0, col - 1); j <= Math.min(col + 1, currentCols - 1); j++) {
                    if (casillas[i][j].dataset.mine === 'true') count++;
                }
            }
            return count;
        }

        function revelarTodasMinas() {
            for (let i = 0; i < currentRows; i++) {
                for (let j = 0; j < currentCols; j++) {
                    let casilla = casillas[i][j];
                    if (casilla.dataset.mine === 'true') {
                        if (casilla.dataset.state === 'flag') continue;
                        casilla.textContent = 'üí£';
                        casilla.classList.add('revealed', 'mine');
                    }
                }
            }
        }

        function mostrarMensaje(texto, esPerdido) {
            mensaje.textContent = texto + ' (Clic en el t√≠tulo para reiniciar)';
            mensaje.style.color = esPerdido ? '#ff4444' : '#44ff44';
        }

        // Iniciar el juego
        iniciarJuego();
    </script>
</body>
</html>