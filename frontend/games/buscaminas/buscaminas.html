<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="buscaminas.css">
    <title>Buscaminas</title>
</head>
<body>
    <div class="container">
        <h1>Buscaminas</h1>
        
        <div class="niveles">
            <button class="nivel-btn activo" data-nivel="facil">F√°cil<br><small>8x8 / 10</small></button>
            <button class="nivel-btn" data-nivel="intermedio">Intermedio<br><small>16x16 / 40</small></button>
            <button class="nivel-btn" data-nivel="experto">Experto<br><small>16x30 / 99</small></button>
        </div>
        
        <div class="info">
            <div class="contador">
                <span>üí£ <span id="minas-restantes">10</span></span>
            </div>
            <div class="contador" id="emoji-cara">üôÇ</div>
            <div class="contador">
                <span>‚è±Ô∏è <span id="tiempo">0</span></span>
            </div>
        </div>

        <div id="mensaje"></div>
        <div id="tablero" class="tablero"></div>
    </div>

    <script>
        const NIVELES = {
            facil: { rows: 8, cols: 8, minas: 10 },
            intermedio: { rows: 16, cols: 16, minas: 40 },
            experto: { rows: 16, cols: 30, minas: 99 }
        };

        let NIVEL_ACTUAL = 'facil';
        let currentRows, currentCols, currentMinas;
        let tablero = document.getElementById('tablero');
        let mensaje = document.getElementById('mensaje');
        let minasRestantesDisplay = document.getElementById('minas-restantes');
        let tiempoDisplay = document.getElementById('tiempo');
        let emojiCara = document.getElementById('emoji-cara');

        let casillas = [];
        let minasMarcadas = 0;
        let casillasReveladas = 0;
        let juegoTerminado = false;
        let tiempoInicio = null;
        let temporizador = null;

        document.querySelectorAll('.nivel-btn').forEach(btn => {
            btn.addEventListener('click', function() {
                document.querySelector('.nivel-btn.activo').classList.remove('activo');
                this.classList.add('activo');
                NIVEL_ACTUAL = this.dataset.nivel;
                reiniciarJuego();
            });
        });

        function iniciarJuego() {
            juegoTerminado = false;
            casillasReveladas = 0;
            minasMarcadas = 0;
            mensaje.textContent = '';
            emojiCara.textContent = 'üôÇ';
            clearInterval(temporizador);
            tiempoDisplay.textContent = '0';
            tiempoInicio = null;

            const config = NIVELES[NIVEL_ACTUAL];
            currentRows = config.rows;
            currentCols = config.cols;
            currentMinas = config.minas;
            minasRestantesDisplay.textContent = currentMinas;

            // Tama√±o de celda din√°mico y legible
            const maxDim = Math.max(currentRows, currentCols);
            const cellSize = Math.max(28, Math.min(50, Math.floor((window.innerWidth - 100) / maxDim)));
            tablero.style.setProperty('--cell-size', `${cellSize}px`);
            tablero.style.setProperty('--cols', currentCols);
            tablero.style.setProperty('--rows', currentRows);

            inicializaTablero();
        }

        function inicializaTablero() {
            tablero.innerHTML = '';
            casillas = [];
            for (let i = 0; i < currentRows; i++) {
                casillas[i] = [];
                for (let j = 0; j < currentCols; j++) {
                    let casilla = document.createElement('div');
                    casilla.classList.add('casilla');
                    casilla.dataset.row = i;
                    casilla.dataset.col = j;
                    casilla.dataset.state = 'hidden';
                    casilla.addEventListener('click', manejarClickIzquierdo);
                    casilla.addEventListener('contextmenu', manejarClickDerecho);
                    tablero.appendChild(casilla);
                    casillas[i][j] = casilla;
                }
            }
        }

        function colocarMinasExcluyendo(excludeRow, excludeCol) {
            let colocadas = 0;
            while (colocadas < currentMinas) {
                let row = Math.floor(Math.random() * currentRows);
                let col = Math.floor(Math.random() * currentCols);
                if ((row !== excludeRow || col !== excludeCol) && casillas[row][col].dataset.mine !== 'true') {
                    casillas[row][col].dataset.mine = 'true';
                    colocadas++;
                }
            }
        }

        function manejarClickIzquierdo(e) {
            e.preventDefault();
            if (juegoTerminado) return;

            let casilla = e.target;
            let row = parseInt(casilla.dataset.row);
            let col = parseInt(casilla.dataset.col);

            if (casilla.dataset.state !== 'hidden') return;

            if (!tiempoInicio) {
                tiempoInicio = Date.now();
                temporizador = setInterval(actualizarTiempo, 1000);
                colocarMinasExcluyendo(row, col);
            }

            if (casilla.dataset.mine === 'true') {
                revelarTodasMinas();
                casilla.classList.add('mina-explotada');
                mostrarMensaje('¬°Boom! Has perdido üí•', true);
                emojiCara.textContent = 'üíÄ';
                juegoTerminado = true;
                clearInterval(temporizador);
            } else {
                revelarCasilla(row, col);
                if (casillasReveladas === currentRows * currentCols - currentMinas) {
                    revelarTodasMinas();
                    mostrarMensaje('¬°Ganaste! üéâ', false);
                    emojiCara.textContent = 'üòé';
                    juegoTerminado = true;
                    clearInterval(temporizador);
                }
            }
        }

        function manejarClickDerecho(e) {
            e.preventDefault();
            if (juegoTerminado) return;

            let casilla = e.target;
            if (casilla.dataset.state === 'revealed') return;

            if (casilla.dataset.state === 'hidden') {
                casilla.textContent = 'üö©';
                casilla.dataset.state = 'flag';
                minasMarcadas++;
            } else if (casilla.dataset.state === 'flag') {
                casilla.textContent = '';
                casilla.dataset.state = 'hidden';
                minasMarcadas--;
            }
            minasRestantesDisplay.textContent = currentMinas - minasMarcadas;
        }

        function revelarCasilla(row, col) {
            let casilla = casillas[row][col];
            if (casilla.dataset.state !== 'hidden') return;

            let count = contarMinasCercanas(row, col);
            casilla.textContent = count || '';
            if (count > 0) casilla.classList.add('num-' + count);
            casilla.dataset.state = 'revealed';
            casilla.classList.add('revealed');
            casillasReveladas++;

            if (count === 0) {
                for (let i = Math.max(0, row - 1); i <= Math.min(row + 1, currentRows - 1); i++) {
                    for (let j = Math.max(0, col - 1); j <= Math.min(col + 1, currentCols - 1); j++) {
                        if (i !== row || j !== col) {
                            revelarCasilla(i, j);
                        }
                    }
                }
            }
        }

        function contarMinasCercanas(row, col) {
            let count = 0;
            for (let i = Math.max(0, row - 1); i <= Math.min(row + 1, currentRows - 1); i++) {
                for (let j = Math.max(0, col - 1); j <= Math.min(col + 1, currentCols - 1); j++) {
                    if (casillas[i][j].dataset.mine === 'true') count++;
                }
            }
            return count;
        }

        function revelarTodasMinas() {
            for (let i = 0; i < currentRows; i++) {
                for (let j = 0; j < currentCols; j++) {
                    let casilla = casillas[i][j];
                    if (casilla.dataset.mine === 'true') {
                        if (casilla.dataset.state === 'flag') continue;
                        casilla.textContent = 'üí£';
                        casilla.classList.add('revealed', 'mine');
                    }
                }
            }
        }

        function mostrarMensaje(texto, esPerdido) {
            mensaje.textContent = texto + ' (Clic en t√≠tulo o nivel para reiniciar)';
            mensaje.style.color = esPerdido ? '#ff4444' : '#44ff44';
        }

        function actualizarTiempo() {
            let segundos = Math.floor((Date.now() - tiempoInicio) / 1000);
            tiempoDisplay.textContent = segundos;
        }

        iniciarJuego();
    </script>
</body>
</html>